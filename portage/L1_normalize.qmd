---
title: "L1_normalize"
author: "COMPASS workflows team"
title-block-banner: true
params:
  L0: "L0/"
  html_outfile: "L1_normalize.html"
  L1_normalize: "L1_normalize/"
  design_table: NULL
date: now
date-format: "YYYY-MM-DD HH:mm:ssZ"
format: 
  html:
    code-fold: true
editor: visual
---

## Initializing

```{r}
#| output: false
library(tidyr)
library(dplyr)
library(readr)

dt <- params$design_table
if(is.null(params$design_table)) 
    dt <- read_csv("design_table.csv")

files_to_process <- list.files(params$L0, pattern = "*.csv$", full.names = TRUE)
```

I see `r length(files_to_process)` files to process.

HTML outfile is "`r params$html_outfile`".

## Processing

```{r}
f <- function(fn, out_dir, design_table) {
    message("Reading ", fn)
    dat <- read_csv(fn, 
                    # don't want timestamp parsed to a datetime at this point
                    col_types = list(TIMESTAMP = col_character()))
    
    dat_long <- pivot_longer(dat, c(-Logger, -Table, -TIMESTAMP),
                             names_to = "loggernet_variable",
                             values_to = "value",
                             # We're stacking both numeric and character columns, 
                             # so force everything to character (no precision 
                             # loss since data came from a text file anyway)
                             values_transform = as.character)
    message("\tPivoted data has ", nrow(dat_long), " rows")
    dat_long <- filter(dat_long, !is.na(value))
    message("\tFiltered data has ", nrow(dat_long), " rows")
    
    message("\tJoining with design table")
    nrow_orig <- nrow(dat_long)
    dat_long <- left_join(dat_long, design_table,
                          by = c("Logger", "Table", "loggernet_variable"))
    print(head(dat_long[c("Logger","Table","loggernet_variable","design_link")]))
    smry <- data.frame(File = fn, 
                       Pivoted_rows = nrow_orig,
                       Joined_rows = nrow(dat_long),
                       design_link_NA = sum(is.na(dat_long$design_link)))

    dat_long <- filter(dat_long, !is.na(design_link))
    
    new_fn <- gsub("L0\\.csv$", "L1_norm\\.csv", basename(fn))
    
    outfile <- file.path(out_dir, new_fn)
    message("\tWriting ", outfile)
    x <- try(write_csv(dat_long, outfile))
    if(is.data.frame(x)) {
        #unlink(fn) # TODO
    } else {
        warning("Write error!")
    }
    return(smry)
}

out <- lapply(files_to_process, f, 
              out_dir = params$L1_normalize,
              design_table = dt)
```

## Summary

```{r}
out_df <- do.call("rbind", out)
knitr::kable(out_df)
```

## Reproducibility

```{r}
sessionInfo()
```
