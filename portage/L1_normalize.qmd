---
title: "L1_normalize"
author: "COMPASS workflows team"
title-block-banner: true
params:
  html_outfile: "L1_normalize.html"
  DATA_ROOT: "data_TEST/"
  L0: "L0/"
  L1_NORMALIZE: "L1_normalize/"
  DESIGN_TABLE: "design_table.csv"
  METADATA_VARS_TABLE: "L1_metadata/L1_metadata_vars.csv"
  debug: false
  remove_input_files: false
  logfile: ""
date: now
date-format: "YYYY-MM-DD HH:mm:ssZ"
format: 
  html:
    code-fold: true
editor: visual
---

This script

-   Reads in the L0 files one by one

-   Joins with the design table, adding `Site`, `design_link`, and `research_name` columns (every loggernet variable must have an entry)

-   Performs unit conversion (every research name must have an entry)

-   Performs bounds checking (adding flags) for each `research_name` variable

-   Writes into <year><month><site> folders

## Initializing

```{r init}
#| include: false

library(tidyr)
library(dplyr)
library(readr)
library(compasstools)
if(packageVersion("compasstools") < "0.2") {
    stop("Please update to latest version of compasstools!\n",
         "devtools::install_github('COMPASS-DOE/compasstools')")
}

# Read the design table (everything must have an entry)
DESIGN_TABLE <- file.path(params$DATA_ROOT, params$DESIGN_TABLE)
dt <- read_csv(DESIGN_TABLE, col_types = "ccccccc")
dt$note <- NULL
# For compactness, the design table may have expansions. For example,
# "DiffVoltA_Avg({1:8})" -> "DiffVoltA_Avg(1)", "DiffVoltA_Avg(2)", etc., with
# extra rows added as needed:
dt_ex <- compasstools::expand_df(dt)

# Read the variable metadata table
METADATA_VARS_TABLE <- file.path(params$DATA_ROOT, params$METADATA_VARS_TABLE)
mt <- read_csv(METADATA_VARS_TABLE, col_types = "ccccccccddc")
# ...and create the units table (everything must have an entry)
mt %>% 
    filter(!is.na(research_name)) %>% 
    select(research_name, conversion, new_unit = final_units) ->
    ut

# Create the bounds table (not everything needs an entry)
mt %>% 
    filter(!is.na(research_name), !is.na(final_units)) %>% 
    select(research_name, units = final_units, low_bound, high_bound) ->
    bt

L0 <- file.path(params$DATA_ROOT, params$L0)
files_to_process <- list.files(L0, pattern = "*.csv$", full.names = TRUE)

L1_NORMALIZE <- file.path(params$DATA_ROOT, params$L1_NORMALIZE)

source("helpers.R")
```

I see `r length(files_to_process)` files to process in `r L0`.

Output directory is `r L1_NORMALIZE`.

Design table "`r DESIGN_TABLE`" and has `r nrow(dt)` rows, `r nrow(dt_ex)` after expansion.

Variable metadata table is "`r METADATA_VARS_TABLE`" and has `r nrow(mt)` rows.

Units table has `r nrow(ut)` rows; bounds table `r nrow(bt)`.

HTML outfile is "`r params$html_outfile`".

## Processing

```{r processing}
overwrites <- 0
errors <- 0

f <- function(fn, out_dir, design_table) {
    message(Sys.time(), " Processing ", basename(fn))
    
    smry <- data.frame(File = basename(fn), 
                       no_design_links = NA_integer_,
                       `OOB%` = NA_real_,
                       Note = "",
                       check.names = FALSE)
    dat <- try(read_csv(fn, 
                        # don't want timestamp parsed to a datetime at this point
                        col_types = list(TIMESTAMP = col_character())))
    if(!is.data.frame(dat)) {
        smry$Note <- "Read error" 
        message("\t", Note)
        errors <<- errors + 1
        return(smry)
    }
    
    # ------------- Design table
    
    # Check for missing entries in the design table
    dat %>% 
        anti_join(design_table,
                  by = c("Logger", "Table", "loggernet_variable")) %>% 
        select(Logger, Table, loggernet_variable) %>% 
        distinct() ->
        missings
    
    if(nrow(missings)) {
        missing_dls <- paste(missings$loggernet_variable, collapse = ", ")
        missing_dls <- strwrap(missing_dls, width = 40)
        message("\tERROR: missing design links: ", 
                paste(missing_dls, collapse = "\n\t\t"))
        smry$Note <- "Missing design link row(s)"
        errors <<- errors + 1
        return(smry)
    }
    
    # Join with design table
    dat <- left_join(dat, design_table,
                     by = c("Logger", "Table", "loggernet_variable"),
                     relationship = "many-to-one")
    
    # Summary information
    smry$no_design_links <- sum(is.na(dat$design_link))
    message("\tFiltering out ", smry$no_design_links, " empty design_link rows")
    dat <- subset(dat, !is.na(dat$design_link))
    
    # If no rows left, note this fact and move on
    if(!nrow(dat)) {
        smry$Note <- "No design links; nothing to process"
        return(smry)
    }
    
    # ------------- Unit conversion
    
    # Check for missing entries in the units table
    rns <- unique(dat$research_name)
    missings <- rns[!rns %in% ut$research_name]
    if(length(missings)) {
        missing_units <- paste(missings, collapse = ", ")
        missing_units <- strwrap(missing_units, width = 40)
        message("\tERROR: missing units entries: ",
                paste(missing_units, collapse = "\n\t\t"))
        smry$Note <- "Missing unit entries" 
        errors <<- errors + 1
        return(smry)
    }
    
    message("\tDoing unit conversion")
    # At this point everything in the value column should be numeric
    dat$value <- as.numeric(dat$value)
    dat <- compasstools::unit_conversion(dat, ut)
    dat <- rename(dat, value_raw = value, value = value_conv)
    dat$value_conv <- NULL
    
    # ------------- Out-of-bounds flags
    
    message("\tAdding OOB flags")
    dat %>% 
        left_join(bt, by = c("research_name", "units")) %>% 
        mutate(OOB = as.integer(value < low_bound | value > high_bound)) ->
        dat
    smry$`OOB%` <- round(sum(dat$OOB) / nrow(dat) * 100, 1)
    
    # Remove unneeded columns unless needed for debugging
    if(!params$debug) {
        message("\tDropping bounds columns")
        dat <- select(dat, -low_bound, -high_bound)
    }
    
    write_to_folders(dat, 
                     root_dir = out_dir, 
                     data_level = "L1_normalize",
                     site = dat$Site[1], 
                     logger = dat$Logger[1],
                     table = dat$Table[1])
    
    if(params$remove_input_files) {
        message("\tRemoving input files")
        file.remove(fn)
    }
    
    return(smry)
}

log_info("About to L1_normalize", logfile = params$logfile)
tryCatch({
out <- lapply(files_to_process, f, 
              out_dir = L1_NORMALIZE,
              design_table = dt_ex)
},
error = function(e) {
    log_warning("L1_normalize: an error occurred!", logfile = params$logfile)
    log_info(as.character(e), logfile = params$logfile)
    stop(e)
})
```

## Summary

```{r summary}
#| echo: false
#| output: asis
if(overwrites) {
    cat("### WARNING: ", overwrites, " file overwrite(s)\n")
    log_warning(paste("File overwrite(s)", params$html_outfile), 
                logfile = params$logfile)
}
if(errors) {
    cat("### ERROR: ", errors, " error(s)\n")
    log_warning(paste("File read/write or processing error(s)", params$html_outfile), 
                logfile = params$logfile)
}
```

```{r summary_table}
out_df <- do.call("rbind", out)
knitr::kable(out_df)
```

## Reproducibility

```{r reproducibility}
sessionInfo()
```
