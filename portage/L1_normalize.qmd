---
title: "L1_normalize"
author: "COMPASS workflows team"
title-block-banner: true
params:
  L0: "data_TEST/L0/"
  html_outfile: "L1_normalize.html"
  L1_normalize: "data_TEST/L1_normalize/"
  design_table: "data_TEST/design_table.csv"
  logfile: ""
date: now
date-format: "YYYY-MM-DD HH:mm:ssZ"
format: 
  html:
    code-fold: true
editor: visual
---

This script

-   Reads in the L0 files one by one

-   Reshapes from wide to long; only `Logger`, `Table`, and `TIMESTAMP` don't get reshaped

-   Joins with the design table, adding `Site` and `design_link` columns

-   Writes into \<year\>\_*\<*month*\>*\_\<site\> folders

## Initializing

```{r}
#| output: false
library(tidyr)
library(dplyr)
library(readr)
library(compasstools)
if(!exists("expand_df")) {
    stop("Please update to latest version of compasstools!\n",
         "devtools::install_github('COMPASS-DOE/compasstools')")
}
dt <- read_csv(params$design_table, col_types = "cccccc")
dt_ex <- expand_df(dt)

files_to_process <- list.files(params$L0, pattern = "*.csv$", full.names = TRUE)

source("helpers.R")
```

I see `r length(files_to_process)` files to process.

Design table is `r nrow(dt)` rows, `r nrow(dt_ex)` after expansion.

HTML outfile is "`r params$html_outfile`".

## Processing

```{r}
overwrites <- 0
errors <- 0

f <- function(fn, out_dir, design_table) {
    message(Sys.time(), " Processing ", basename(fn))

    smry <- data.frame(File = basename(fn), 
                       Pivoted_rows = NA_integer_,
                       Joined_rows = NA_integer_,
                       dl_NA = NA_integer_,
                       dl_NA_top3 = NA_character_,
                       note = "")
    dat <- try(read_csv(fn, 
                    # don't want timestamp parsed to a datetime at this point
                    col_types = list(TIMESTAMP = col_character())))
    if(!is.data.frame(dat)) {
        smry$note <- "Read error" 
        errors <<- errors + 1
        return(smry)
    }
    
    dat_long <- pivot_longer(dat, c(-Logger, -Table, -TIMESTAMP),
                             names_to = "loggernet_variable",
                             values_to = "value",
                             # We're stacking both numeric and character columns, 
                             # so force everything to character (no precision 
                             # loss since data came from a text file anyway)
                             values_transform = as.character)
    message("\tPivoted data has ", nrow(dat_long), " rows")
    dat_long <- filter(dat_long, !is.na(value))
    message("\tFiltered data has ", nrow(dat_long), " rows")
    
    # Join with design table
    nrow_orig <- nrow(dat_long)
    dat_long <- left_join(dat_long, design_table,
                          by = c("Logger", "Table", "loggernet_variable"))
    
    # Compute the top three loggernet variables with missing design links
    dat_long %>% 
        filter(is.na(design_link)) %>% 
        group_by(loggernet_variable) %>% 
        summarise(N = n()) %>% 
        arrange(desc(N)) %>% 
        slice_head(n = 3) %>% 
        pull(loggernet_variable) ->
        top3_na_vars
    
    smry$Pivoted_rows <- nrow_orig
    smry$Joined_rows <- nrow(dat_long)
    smry$dl_NA <- sum(is.na(dat_long$design_link))
    smry$dl_NA_top3 <- paste(top3_na_vars, collapse = ", ")

    message("\tFiltering out missing design_link rows")
    dat_long <- filter(dat_long, !is.na(design_link))
    
    write_to_folders(dat_long, root_dir = out_dir, data_level = "L1_normalize",
                     site = dat_long$Site[1], 
                     logger = dat_long$Logger[1], table = dat_long$Table[1])

    return(smry)
}

out <- lapply(files_to_process, f, 
              out_dir = params$L1_normalize,
              design_table = dt_ex)
```

## Summary

```{r}
#| echo: false
#| output: asis
if(overwrites) {
    cat("### WARNING: ", overwrites, " file overwrite(s)\n")
    log_warning(paste("File overwrite(s)", params$html_outfile), 
                logfile = params$logfile)
}
if(errors) {
    cat("### WARNING: ", errors, " file read/write error(s)\n")
    log_warning(paste("File read/write error(s)", params$html_outfile), 
                logfile = params$logfile)
}
```

```{r}
out_df <- do.call("rbind", out)
knitr::kable(out_df)
```

## Reproducibility

```{r}
sessionInfo()
```
