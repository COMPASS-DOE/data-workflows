---
title: "L1a"
author: "COMPASS workflows team"
title-block-banner: true
params:
  L1_normalize: "data/L1_normalize/"
  L1a: "data/L1a/"
  html_outfile: "L1a.html"
date: now
date-format: "YYYY-MM-DD HH:mm:ssZ"
format: 
  html:
    code-fold: true
editor: visual
---

## Initializing

```{r}
#| output: false
library(tidyr)
library(dplyr)
library(readr)

source("helpers.R")

files_to_process <- list.files(params$L1_normalize, pattern = "*.csv$", full.names = TRUE)

source("helpers.R")
```

I see `r length(files_to_process)` files to process.

HTML outfile is "`r params$html_outfile`".

## Processing

```{r}
overwrites <- 0
errors <- 0

f <- function(fn, out_dir) {
    message(Sys.time(), " Processing ", basename(fn))
    smry <- data.frame(File = fn, Rows = NA_integer_, OOB_rows = NA_integer_, note = "")
    dat <- try(read_csv(fn, 
                    # don't want timestamp parsed to a datetime at this point
                    col_types = list(TIMESTAMP = col_character())))

    if(!is.data.frame(dat)) {
        smry$note <- "Read error" 
        errors <<- errors + 1
        return(smry)
    }
  
    message("\tDoing unit conversion")
    # Do unit conversion
    
    message("\tAdding units and OOB flags")
    # Create out-of-bounds flags
    dat$OOB <- 0 # temporary
    dat$Units <- "units" # temporary
    
    # TODO: we could remove the Logger and Table columns at this point, as the 
    # information is being encoded into the filename
    write_to_folders(dat, root_dir = out_dir, site = dat$Site[1], 
                     logger = dat$Logger[1], table = dat$Table[1])
    file.remove(fn) # TODO: need to confirm no error occurred in write_to_folders
    
    smry$Rows <- nrow(dat)
    return(smry)
}

out <- lapply(files_to_process, f, out_dir = params$L1a)
```

## Summary

```{r}
#| echo: false
#| output: asis
if(overwrites) {
    cat("### WARNING: ", overwrites, " file overwrite(s)\n")
    log_warning(paste("File overwrite(s)", params$html_outfile), 
                logfile = params$logfile)
}
if(errors) {
    cat("### WARNING: ", errors, " file read/write error(s)\n")
    log_warning(paste("File read/write error(s)", params$html_outfile), 
                logfile = params$logfile)
}
```

```{r}
out_df <- do.call("rbind", out)
knitr::kable(out_df)
```

## Reproducibility

```{r}
sessionInfo()
```
