---
title: "Workflow: raw_to_L0"
author: "COMPASS workflows team"
title-block-banner: true
params:
  outfile: "raw_to_L0.html"
  raw: "Raw/"
  L0: "L0/"
date: now
date-format: "YYYY-MM-DD HH:mm:ssZ"
format: 
  html:
    code-fold: true
editor: visual
---

## Initializing

```{r}
library(compasstools)
library(readr)
files_to_process <- list.files("Raw/", pattern = "*.dat$", full.names = TRUE)
```

I see `r length(files_to_process)` files to process.

Outfile is "`r params$outfile`".

## Processing

```{r}
f <- function(fn, new_dir) {
    message(Sys.time(), " Processing ", basename(fn))
    dat <- try(compasstools::read_sapflow_file(fn))
    new_fn <- gsub("\\.dat$", "_L0\\.csv", basename(fn))
    note <- ""
    if(is.data.frame(dat)) {
        write.csv(dat, file.path(new_dir, new_fn), row.names = FALSE)
    } else {
        note <- "Error"
    }
    data.frame(File = basename(fn),
               Logger = dat$Logger[1],
               Table = dat$Table[1],
               Rows = nrow(dat),
               Columns = ncol(dat),
               Note = note)
}

out <- lapply(files_to_process, f, new_dir = "./L0/")
```

## Summary

```{r}
out_df <- do.call("rbind", out)
knitr::kable(out_df)
```

## Reproducibility

```{r}
sessionInfo()
```
